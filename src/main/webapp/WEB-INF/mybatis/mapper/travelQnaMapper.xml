<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="travelQna">
	<sql id="search">
		<if test="searchKey=='all'">
			INSTR(SUBJECT,#{searchValue}) &gt; 0 or INSTR(CONTENT,#{searchValue}) &gt; 0
		</if>
		<if test="searchKey=='subject'">
			INSTR(SUBJECT,#{searchValue}) &gt; 0
		</if>
		<if test="searchKey=='content'">
			INSTR(CONTENT,#{searchValue}) &gt; 0
		</if>
		<if test="searchKey=='userName'">
			INSTR(userName,#{searchValue}) &gt; 0
		</if>
		<if test="searchKey=='created'">
			to_char(created,'yyyy-mm-dd')=#{searchValue}
		</if>
	</sql>
	
	<select id="qnaCount" parameterType="map" resultType="Integer">
		select NVL(count(*),0) from question q join tb_user u on q.userIdx=u.userIdx
		<where>
			<if test="searchKey!=''">
				<include refid="search"/>
			</if>
			and catCode=3
		</where>
	</select>
	<select id="qnaList" parameterType="map" resultType="com.sp.travel.qna.TQuestion">
		select * from (
			select tb.*, rownum rnum from(
				select qnaCode, catCode, subject, q.created, content, isSatisfied,q.userIdx, userName
				from question q join tb_user u on q.userIdx=u.userIdx
				<where>
					<if test="searchKey!=''">
						<include refid="search"/>
					</if>
					and catCode=3
				</where>
				order by qnaCode desc
			)tb where rownum &lt;= #{end}
		) where rnum &gt;= #{start}
	</select>
	<select id="answerList" parameterType="map" resultType="com.sp.travel.qna.Answer">
			select answerCode, qnaCode, answerCreated, answerContent, a.adminIdx, adminName
				from answer an join admin a on an.adminIdx=a.adminIdx
					where qnaCode=#{qnaCode}
						order by answerCode asc
	</select>
	
	<insert id="insertAnswer" parameterType="com.sp.travel.qna.Answer">
			insert into answer(answerCode, qnaCode, answerContent, adminIdx) values(answerCode_seq.nextval,#{qnaCode},#{answerContent},#{adminIdx})
	</insert>
	
	<delete id="deleteAnswer" parameterType="Integer">
		delete from answer where answerCode=#{answerCode}
	</delete>
	
</mapper>